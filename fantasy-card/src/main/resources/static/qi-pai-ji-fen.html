<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">
    <title>æ–—ä¹Ÿæ–—å¾—</title>
    <link rel="stylesheet" href="css/plugin/frozen.css"/>
    <link rel="stylesheet" href="css/common.css"/>
    <script src="js/plugin/axios.min.js"></script>
    <script src="js/plugin/vue.min.js"></script>
    <script src="js/CommonUtil.js"></script>
</head>
<style>

</style>
<body>
<div id="app">
    <header class="ui-header ui-header-positive ui-border-b text-center">
        <a class="position-left username-display" href="/fantasy-card/fang-jian-lie-biao.html">è¿”å›</a>
        <span class="font-weight-bolder font-weight-20px">{{roomCode || "æ–—ä¹Ÿæ–—çš„"}}</span>
        <span class="position-right ui-txt-red font-weight-bolder" @click="playerOutRoom"
              v-if="userStatus === '1'">æˆ‘è¦ä¸‹æ¡Œ</span>
        <span class="position-right username-display" @click="playerJoinRoom"
              v-if="userStatus === '0'">æˆ‘è¦ä¸Šæ¡Œ</span>
    </header>
    <div class="ui-form ui-border-t ui-container">
        <ul class="ui-row ui-whitespace overflow-auto" style="max-height: 220px;">
            <li class="ui-col ui-col-25 margin-top-1em" v-for="player in playerList"
                @click="selectTransferTarget(player)">
                <div class="ui-avatar-lg background-dingding text-line-height-70px text-center background-A-c"
                     v-bind:class="{'background-B-c': player.playerStatus !== '1'}">
                    {{player.playerName}}
                </div>
                <div class="text-center width-70px font-weight-bolder">
                    {{player.playerScore}}
                </div>
            </li>
        </ul>
        <transition name="slide-fade">
            <div class="ui-tooltips ui-tooltips-warn" v-if="tips">
                <div class="ui-tooltips-cnt ui-border-b">
                    <i></i>{{tips}}
                </div>
            </div>
        </transition>
        <div class="ui-tab margin-top-1em">
            <ul class="ui-tab-nav ui-border-b">
                <li @click="showRoom = true" v-bind:class="{'current': showRoom}"><span>æˆ¿é—´</span></li>
                <li @click="showRoom = false" v-bind:class="{'current': !showRoom}"><span>æˆ‘çš„</span></li>
            </ul>
            <ul class="ui-tab-content">
                <li v-if="showRoom">
                    <ul class="ui-list ui-list-function ui-border-tb overflow-auto"
                        style="max-height: calc(100vh - 300px)" @scroll="onScroll" ref="scrollTarget">
                        <li v-for="item in messageList">
                            <div class="ui-list-info ui-border-t" v-bind:class="{'from-myself':item.from === userId}">
                                <p class="ui-nowrap">{{item.time}}</p>
                                <p v-html="item.msg"></p>
                            </div>
                        </li>
                    </ul>
                </li>
                <li v-else>
                    <ul class="ui-list ui-list-function ui-border-tb overflow-auto"
                        style="max-height: calc(100vh - 300px)" @scroll="onScroll" ref="historyScrollTarget">
                        <li v-for="item in historyMessageList">
                            <div class="ui-list-info ui-border-t" v-bind:class="{'from-myself':item.from === userId}">
                                <p class="ui-nowrap">{{item.time}}</p>
                                <p v-html="item.msg"></p>
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
    <transition name="slide-fade">
        <div class="ui-dialog show" v-if="currentSelectedPlayer">
            <div class="ui-dialog-cnt">
                <div class="ui-dialog-bd">
                    <h3>
                        è½¬è´¦ç»™
                        <span class="username-display">
                            {{currentSelectedPlayer && currentSelectedPlayer.playerName}}
                        </span>
                    </h3>
                </div>
                <div class="ui-form-item ui-border-b">
                    <div class="ui-input ui-input-text">
                        <input type="number" class="text-center padding-0" v-model="transferAmount"
                               minlength="1" maxlength="4" placeholder="è¯·è¾“å…¥è½¬è´¦æ•°é¢"/>
                    </div>
                </div>
                <div class="ui-dialog-ft">
                    <button type="button" data-role="button" @click="cancelTransfer">å–æ¶ˆ</button>
                    <button type="button" data-role="button" @click="confirmTransfer">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </transition>
</div>
</body>
<script>
    // è·å–æˆ¿é—´å·
    let roomId = localStorage.getItem("user.room.id") || "1";
    // è·å–ç”¨æˆ·TOKEN
    let accessToken = localStorage.getItem("user.access.token");
    // websocketå¯¹è±¡
    let ws;

    // çª—å£æ¿€æ´»
    function windowActivatedFunction() {
        // è¿æ¥websocket
        connectWebsocket();
        // æŸ¥è¯¢å…³äºæˆ‘çš„å†å²æ¶ˆæ¯
        vm.queryHistoryMessageAboutMine();
    }

    // çª—å£å¤±æ´»
    function windowDeactivatedFunction() {
        // å…³é—­websocket
        if (ws && typeof (ws.close) === 'function') {
            ws.close();
        }
    }

    // è¿æ¥websocket
    function connectWebsocket() {
        // websocketçŠ¶æ€æ­£å¸¸
        if (ws && ws.readyState === 1) {
            return;
        }
        // è¿æ¥websocket
        // const ws = new WebSocket("ws://127.0.0.1:9020/websocket/stat.score/" + roomId + "/" + accessToken);
        ws = new WebSocket("ws://" + location.host + "/fantasy-card/websocket/stat.score/" + roomId + "/" + accessToken);

        // è¿æ¥
        ws.onopen = function (evt) {
            console.log("connection open ...");

            // æ”¶åˆ°æ¶ˆæ¯
            ws.onmessage = function (evt) {
                // è¿”å›ä¿¡æ¯ååºåˆ—åŒ–
                let res = JSON.parse(evt.data);
                console.log(res);
                // è®¾ç½®vueå˜é‡
                vm.playerList = commonUtil.getPageList(res);
                // éå†å½“å‰ç”¨æˆ·çš„ä¸Šæ¡ŒçŠ¶æ€
                vm.playerList.forEach(item => {
                    if (vm.userId === item.id) {
                        vm.userStatus = item.playerStatus;
                    }
                })
                // åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶ˆæ¯
                if (res.msg) {
                    // æ¶ˆæ¯åˆ—è¡¨
                    vm.messageList.push({"msg": res.msg, "time": res.time, "from": res.from});
                    if (res.from === vm.userId || res.to === vm.userId) {
                        // å…³äºæˆ‘çš„å†å²æ¶ˆæ¯
                        vm.historyMessageList.push({"msg": res.msg, "time": res.time, "from": res.from});
                    }
                    // æ–°æ¶ˆæ¯çš„æ»šåŠ¨
                    vm.scrollToBottom();
                }
            };

            // å…³é—­
            ws.onclose = function (evt) {
                console.log("connection closed ...");
            };
        };
    }

    const vm = new Vue({
        el: "#app",
        data: {
            // æç¤º
            tips: "",
            // ç”¨æˆ·ID
            userId: "",
            // ç”¨æˆ·åç§°
            username: "",
            // æ˜¯å¦æ˜¾ç¤ºæˆ¿é—´
            showRoom: false,
            // ç”¨æˆ·ä¸Šæ¡ŒçŠ¶æ€
            userStatus: null,
            // æˆ¿é—´å·
            roomCode: null,
            // æ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
            autoScroll: true,
            // è½¬è´¦æ•°é¢
            transferAmount: "",
            // å½“å‰é€‰ä¸­çš„é€‰æ‰‹
            currentSelectedPlayer: null,
            // é€‰æ‰‹åˆ—è¡¨
            playerList: [],
            // å½“å‰æ¨é€çš„æ‰€æœ‰æ¶ˆæ¯
            messageList: [{"msg": "ç‚¹å‡»ä»–äººå¤´åƒå³å¯è¿›è¡Œè½¬è´¦", "time": "ğŸ’¬", "from": ""}],
            // å…³äºæˆ‘çš„å†å²æ¶ˆæ¯
            historyMessageList: [{"msg": "ç‚¹å‡»ä»–äººå¤´åƒå³å¯è¿›è¡Œè½¬è´¦", "time": "ğŸ’¬", "from": ""}],
        },
        methods: {
            // ç›‘å¬æ»šåŠ¨
            onScroll() {
                // æ»šåŠ¨æ¡é«˜åº¦ - è·ç¦»é¡¶éƒ¨çš„è·ç¦» - åƒç´ é«˜åº¦
                let scrollBottom = this.$refs.scrollTarget.scrollHeight - this.$refs.scrollTarget.scrollTop - this.$refs.scrollTarget.offsetHeight;
                // å¦‚æœæ»šåŠ¨åˆ°åº•éƒ¨å°äº50pxäº†åˆ™è‡ªåŠ¨æ»šåŠ¨
                this.autoScroll = scrollBottom < 50;
            },
            // æ¥æ–°æ¶ˆæ¯,åˆ¤æ–­æ˜¯å¦æ»šåŠ¨
            scrollToBottom() {
                if (!this.autoScroll) {
                    return;
                }
                // è‡ªåŠ¨æ»šåŠ¨
                setTimeout(() => {
                    this.$refs.scrollTarget.scrollTop = this.$refs.scrollTarget.scrollHeight;
                })
            },
            // é€‰ä¸­è½¬è´¦å¯¹è±¡
            selectTransferTarget(player) {
                if (player.id === this.userId) {
                    this.tips = "ä¸èƒ½å¯¹è‡ªå·±è½¬è´¦";
                    return;
                }
                if (player.playerStatus === "1") {
                    this.tips = "";
                    this.currentSelectedPlayer = player;
                    return;
                }
                this.tips = "ä¸èƒ½å¯¹å·²ä¸‹æ¡Œçš„äººè½¬è´¦";
            },
            // ç¡®è®¤è½¬è´¦
            confirmTransfer() {
                if (this.transferAmount > 9999) {
                    alert("è½¬è´¦æ•°é¢ä¸èƒ½å¤§äº9999");
                    return;
                }
                if (this.transferAmount < 1) {
                    alert("è½¬è´¦æ•°é¢ä¸èƒ½å°äº1");
                    return;
                }
                let message = "<span class='username-display'>" + this.username
                    + "</span>å‘<span class='username-display'>" + this.currentSelectedPlayer.playerName
                    + "</span>è½¬è´¦äº†<span class='username-display'>" + this.transferAmount + "</span>ç§¯åˆ†";
                const param = {
                    "roomId": roomId,
                    "from": this.userId,
                    "to": this.currentSelectedPlayer.id,
                    "change": this.transferAmount,
                    "message": message,
                }
                // éšè—çª—å£
                this.cancelTransfer();
                // è¯·æ±‚
                axios({
                    method: "post",
                    url: "/fantasy-card/api/v1/card/room.player/transfer.score",
                    data: param
                }).then(res => {
                    // éšè—çª—å£
                    this.cancelTransfer();
                }).catch(res => {
                    if (res.data && res.data.msg) {
                        alert(res.data.msg)
                    } else {
                        alert("æœåŠ¡å™¨ç¹å¿™,è¯·ç¨åå†è¯•")
                    }
                })
            },
            // ç”¨æˆ·ä¸‹æ¡Œ
            playerOutRoom() {
                const param = {
                    "roomId": roomId,
                    "userId": this.userId,
                    "username": this.username,
                }
                // è¯·æ±‚
                axios({
                    method: "post",
                    url: "/fantasy-card/api/v1/card/room.player/player.out.room",
                    data: param
                }).then(res => {

                }).catch(res => {
                    if (res.data && res.data.msg) {
                        alert(res.data.msg)
                    } else {
                        alert("æœåŠ¡å™¨ç¹å¿™,è¯·ç¨åå†è¯•")
                    }
                })
            },
            // ç”¨æˆ·ä¸Šæ¡Œ
            playerJoinRoom() {
                const param = {
                    "roomId": roomId,
                    "userId": this.userId,
                    "username": this.username,
                }
                // è¯·æ±‚
                axios({
                    method: "post",
                    url: "/fantasy-card/api/v1/card/room.player/player.join.room",
                    data: param
                }).then(res => {

                }).catch(res => {
                    if (res.data && res.data.msg) {
                        alert(res.data.msg)
                    } else {
                        alert("æœåŠ¡å™¨ç¹å¿™,è¯·ç¨åå†è¯•")
                    }
                })
            },
            // å–æ¶ˆè½¬è´¦(éšè—çª—å£)
            cancelTransfer() {
                // è½¬è´¦æ•°é¢ç½®ç©º
                this.transferAmount = "";
                // å·²é€‰ä¸­é€‰æ‰‹ç½®ç©º
                this.currentSelectedPlayer = null;
            },
            // æŸ¥è¯¢å…³äºæˆ‘çš„å†å²æ¶ˆæ¯
            queryHistoryMessageAboutMine() {
                // è¯·æ±‚
                axios({
                    method: "post",
                    url: "/fantasy-card/api/v1/card/room.player/query.room.player.history.message"
                }).then(res => {
                    this.historyMessageList = [{"msg": "ç‚¹å‡»ä»–äººå¤´åƒå³å¯è¿›è¡Œè½¬è´¦", "time": "ğŸ’¬", "from": ""}];
                    commonUtil.getPageList(res).forEach(item => {
                        this.historyMessageList.push({"msg": item.msg, "time": item.time, "from": item.from});
                    })
                }).catch(res => {
                    if (res.data && res.data.msg) {
                        alert(res.data.msg)
                    } else {
                        alert("æœåŠ¡å™¨ç¹å¿™,è¯·ç¨åå†è¯•")
                    }
                })
            }
        },
        created() {
            // è·å–ç”¨æˆ·ID
            let userInfo = localStorage.getItem("user.info");
            if (userInfo) {
                userInfo = JSON.parse(userInfo)
                this.userId = userInfo.id;
                this.username = userInfo.username;
            }
            // è·å–æˆ¿é—´å·
            let roomCode = localStorage.getItem("user.room.code");
            if (roomCode) {
                this.roomCode = roomCode;
            }

            // æŸ¥è¯¢å…³äºæˆ‘çš„å†å²æ¶ˆæ¯
            this.queryHistoryMessageAboutMine();

            // è¿æ¥websocket
            connectWebsocket();
        }
    });
</script>

</html>
