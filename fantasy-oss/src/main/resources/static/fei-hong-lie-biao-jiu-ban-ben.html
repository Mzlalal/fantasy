<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">
    <title>尺墨飞虹旧版</title>
    <link rel="stylesheet" href="css/plugin/frozen.css"/>
    <link rel="stylesheet" href="css/common.css"/>
    <script src="js/plugin/axios.min.js"></script>
    <script src="js/plugin/vue.min.js"></script>
    <script src="js/CommonUtil.js"></script>
    <script src="js/FantasyConstant.js"></script>
    <script src="js/components/PopupMenu.js"></script>
</head>
<style>
    .ui-list-function .ui-list-info {
        padding-right: 12px;
    }

    .ui-header {
        height: 90px;
    }

    .ui-header ~ .ui-container {
        border-top: 90px solid transparent;
    }

    .ui-list {
        margin-top: 90px;
    }

    .ui-header-positive i {
        color: #ccc;
    }

</style>
<body>
<div id="app">
    <header class="ui-header ui-header-positive ui-border-b">
        <span class="username-display" @click="menuShow = true">我的菜单</span>

        <div class="position-left-search ui-searchbar-wrap ui-border-b" v-bind:class="{'focus': searchBar}">
            <div class="ui-searchbar ui-border-radius" @click="changeSearchBar(true)">
                <i class="ui-icon-search"></i>
                <div class="ui-searchbar-text">搜索关键字</div>
                <div class="ui-searchbar-input">
                    <input v-model="searchKeyword" type="text" placeholder="搜索关键字"
                           ref="searchInput" autocapitalize="off">
                </div>
                <i class="ui-icon-close" v-on:click.stop="changeSearchBar(false)"></i>
            </div>
            <button class="ui-searchbar-cancel" @click="searchConfirm">确认</button>
        </div>
    </header>

    <ul class="ui-list ui-list-function ui-border-tb">
        <li v-for="diary in diaryList">
            <div class="ui-list-info ui-border-t">
                <span class="font-size-14px">{{diary.diaryDate}}</span>
                <span class="font-size-14px" style="margin-left: 5px;">{{diary.diaryContent}}</span>
            </div>
        </li>
        <div v-if="loading" class="ui-loading-wrap margin-top-1em">
            <p>加载中</p>
            <i class="ui-loading"></i>
        </div>
    </ul>

    <template-popup-menu :menu-show="menuShow" @on-close="menuShow = false">
        <slot>
            <button @click="redirectLatestVersion">切换至新版本</button>
        </slot>
    </template-popup-menu>
</div>
</body>
<script>
    new Vue({
        el: "#app",
        data() {
            return {
                // 当前页
                currPage: 1,
                // 总页数
                totalPage: 0,
                // 加载中
                loading: false,
                // 菜单显示
                menuShow: false,
                // 搜索框
                searchBar: false,
                // 搜索关键字
                searchKeyword: null,
                // 飞虹列表
                diaryList: [],
            }
        },
        methods: {
            // 查询确认
            searchConfirm() {
                // 清空列表
                this.diaryList = [];
                // 查询
                this.initDiaryList();
            },
            // 加载飞虹列表
            initDiaryList() {
                this.loading = true;
                const param = {
                    "entity": {
                        "diaryContent": this.searchKeyword,
                    },
                    "pageInfo": {
                        "currPage": this.currPage,
                        "pageSize": 2147483647
                    }
                }
                // 请求
                axios({
                    method: "post",
                    url: "/fantasy-oss/api/v1/oss/diary/list",
                    data: param
                }).then(res => {
                    // 追加到集合中
                    this.diaryList = this.diaryList.concat(commonUtil.getPageList(res));
                    // 获取到总页数
                    this.totalPage = commonUtil.getTotalPage(res);
                    this.loading = false;

                    // 滚动到底部
                    setTimeout(() => {
                        window.scrollTo(0, 2147483647);
                    });
                }).catch(res => {
                    this.loading = false;
                    if (res.data && res.data.msg) {
                        alert(res.data.msg)
                    } else {
                        alert("服务器繁忙，请稍后再试")
                    }
                })
            },
            // 更改搜索框
            changeSearchBar(bool) {
                // 设置搜索框状态
                this.searchBar = bool;
                // 清空列表
                this.diaryList = [];
                // 重置为第一页
                this.currPage = 1;
                // 关闭窗口
                if (bool) {
                    // 获取焦点
                    this.$nextTick(() => {
                        this.$refs.searchInput.focus();
                    });
                } else {
                    // 关键字
                    this.searchKeyword = null;
                    // 重新查询
                    this.initDiaryList();
                }
            },
            // 切换至新版本
            redirectLatestVersion() {
                window.location = "/fantasy-oss/fei-hong-lie-biao.html";
            }
        },
        created() {
            // 加载飞虹列表
            this.initDiaryList();
        }
    });
</script>

</html>
