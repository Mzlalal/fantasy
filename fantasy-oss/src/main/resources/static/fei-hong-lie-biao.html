<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no"
          name="viewport">
    <title>é£è™¹åˆ—è¡¨</title>
    <link href="css/plugin/frozen.css" rel="stylesheet"/>
    <link href="css/common.css" rel="stylesheet"/>
    <link href="css/plugin/vant.css" rel="stylesheet">
    <script src="js/plugin/axios.min.js"></script>
    <script src="js/plugin/vue.min.js"></script>
    <script src="js/plugin/vant.min.js"></script>
    <script src="js/CommonUtil.js"></script>
    <script src="js/FantasyConstant.js"></script>
    <script src="js/components/DownSlideStream.js"></script>
    <script src="js/components/PopupMenu.js"></script>
    <style>
        /* åŠ¨æ€å¡ç‰‡æ ·å¼ä¼˜åŒ– */
        .diary-cell {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin: 12px auto;
            padding: 16px;
            border: 1px solid #f5f5f5;
            transition: all 0.3s ease;
            width: 400px;
            max-width: 90vw;
            box-sizing: border-box;
        }

        .diary-cell:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
        .diary-user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .diary-username {
            font-size: 14px;
            font-weight: 500;
            color: #323233;
        }

        .diary-create-time {
            font-size: 12px;
            color: #969799;
            text-align: right;
        }

        /* å†…å®¹åŒºåŸŸ */
        .diary-content {
            font-size: 16px;
            line-height: 1.6;
            color: #323233;
            word-break: break-word;
            margin: 0;
            padding: 0;
            white-space: pre-wrap;
            font-family: inherit;
            text-align: left;
        }

        .diary-content p {
            margin: 0 0 8px 0;
        }

        .diary-content p:last-child {
            margin-bottom: 0;
        }

        /* æœç´¢æ¡†å®šä½ */
        .position-left-search {
            margin-top: 45px;
        }

        /* å¤´éƒ¨å®¹å™¨æ ·å¼ */
        .ui-header ~ .ui-container {
            border-top: 0 !important;
        }

        /* æœç´¢æ¡†è¾“å…¥æ¡†æ ·å¼ */
        .ui-searchbar input {
            padding: unset !important;
        }

        /* æ­¥éª¤ç»„ä»¶æ ·å¼è°ƒæ•´ */
        .van-steps {
            background: #f8f8f8;
            padding: 8px 0;
        }

        .van-step__title {
            padding: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #646566;
            text-align: center;
            background: #f2f3f5;
            border-radius: 20px;
            display: inline-block;
            margin: 6px 12px;
            box-shadow: 2px 4px 3px rgba(0, 0, 0, 0.1);
        }

        .van-step--vertical {
            padding: unset;
        }

        .van-step__circle-container {
            display: none;
        }

        .van-step__line {
            display: none;
        }

        /* åº•éƒ¨æŒ‰é’®ä¼˜åŒ– */
        .ui-footer-btn {
            background: #ffffff;
            border-top: 1px solid #ebedf0;
        }

        .ui-footer-btn a {
            color: #18b4ed;
            font-weight: 500;
        }

        /* åº•éƒ¨æŒ‰é’®åŒºåŸŸä¼˜åŒ– */
        .ui-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }


        /* é¡µé¢å†…å®¹åŒºåŸŸè°ƒæ•´ï¼Œç¡®ä¿åº•éƒ¨æŒ‰é’®ä¸é®æŒ¡å†…å®¹ */
        .van-steps {
            padding-bottom: 80px; /* ä¸ºå›ºå®šåº•éƒ¨æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #969799;
            font-size: 14px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .diary-cell {
                width: 85vw;
                max-width: none;
                margin: 6px 6px;
                padding: 6px;
            }

            .diary-content {
                font-size: 15px;
            }

            .diary-user-info {
                margin-bottom: 8px;
            }

            .van-steps {
                padding-bottom: 70px;
            }
        }

        /* åŠ è½½çŠ¶æ€ä¼˜åŒ– */
        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #969799;
        }
    </style>
</head>
<body>
<div id="app">
    <header class="ui-header ui-header-positive ui-border-b text-center">
        <span @click="menuShow = true" class="position-left username-display">æˆ‘çš„èœå•</span>
        <span @click="redirectFollower" class="position-right username-display">æˆ‘çš„ç²‰ä¸</span>
    </header>
    <div class="position-left-search ui-searchbar-wrap ui-border-b" v-bind:class="{'focus': searchBar}">
        <div @click="changeSearchBar(true)" class="ui-searchbar ui-border-radius">
            <i class="ui-icon-search"></i>
            <div class="ui-searchbar-text">æœç´¢å…³é”®å­—</div>
            <div class="ui-searchbar-input">
                <input autocapitalize="off" placeholder="æœç´¢å…³é”®å­—" ref="searchInput"
                       type="text" v-model="searchKeyword">
            </div>
            <i class="ui-icon-close" v-on:click.stop="changeSearchBar(false)"></i>
        </div>
        <button @click="searchConfirm" class="ui-searchbar-cancel">ç¡®è®¤</button>
    </div>
    <template-down-slide-stream :distance-to-bottom="200"
                                :has-been-bottom="currPage >= totalPage"
                                :has-data="diaryGroup && Object.keys(diaryGroup).length > 0"
                                :loading="loading"
                                :offset-to-bottom="100"
                                @on-scroll-to-bottom="onScrollToBottom">
        <slot>
            <!-- æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨ -->
            <van-steps v-if="diaryGroup && Object.keys(diaryGroup).length > 0" active-color="#969799" direction="vertical">
                <van-step :key="index" v-for="(value, key, index) in diaryGroup">
                    <div class="van-step__title"> ğŸ“… {{key}}</div>
                    <div @click="updateDiary(item)" class="diary-cell" v-for="item in value">
                        <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
                        <div class="diary-user-info">
                            <div class="diary-username">{{item.createName}}</div>
                            <div class="diary-create-time">{{item.createTime}}</div>
                        </div>
                        <!-- å†…å®¹åŒºåŸŸ -->
                        <pre class="diary-content">{{item.diaryContent}}</pre>
                    </div>
                </van-step>
            </van-steps>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="loading && currPage === 1" class="loading-indicator">
                æ­£åœ¨åŠ è½½ä¸­...
            </div>
        </slot>
    </template-down-slide-stream>

    <footer class="ui-footer ui-footer-btn">
        <ul class="ui-tiled ui-border-t">
            <li class="ui-border-r">
                <div>
                    <a href="/fantasy-oss/tian-jia-fei-hong.html">å‘ä¸ªåŠ¨æ€</a>
                </div>
            </li>
        </ul>
    </footer>

    <template-popup-menu :menu-show="menuShow" @on-close="menuShow = false">
        <slot>
            <button @click="redirectOlderVersion">åˆ‡æ¢è‡³æ—§ç‰ˆæœ¬</button>
        </slot>
        <slot>
            <button @click="redirectStat">å°ºå¢¨è™¹è®°</button>
        </slot>
        <slot>
            <button @click="redirectSubscribe">æˆ‘çš„è®¢é˜…</button>
        </slot>
    </template-popup-menu>
</div>
</body>
<script>
    new Vue({
        el: "#app",
        data() {
            return {
                // åŠ è½½ä¸­
                loading: false,
                // èœå•æ˜¾ç¤º
                menuShow: false,
                // åˆ—è¡¨å“¦æ•°æ®
                diaryGroup: {},
                // å½“å‰é¡µ
                currPage: 1,
                // æ€»é¡µæ•°
                totalPage: 0,
                // ç”¨æˆ·ä¿¡æ¯
                user: null,
                // æœç´¢æ¡†
                searchBar: false,
                // æœç´¢å…³é”®å­—
                searchKeyword: null,
            }
        },
        methods: {
            onScrollToBottom() {
                this.loading = true;
                // é˜²æŠ–åŠ¨
                commonUtil.debounce(() => {
                    // æ€»é¡µæ•°å°äºç­‰äºå½“å‰é¡µ,åˆ™ä¸åŠ è½½
                    if (this.totalPage <= this.currPage) {
                        this.loading = false;
                        return;
                    }
                    // å½“å‰é¡µ+1
                    this.currPage++;
                    // åŠ è½½ä¸‹ä¸€é¡µ
                    this.initDiaryList()
                }, 250);
            },
            // åˆå§‹åŒ–æ•°æ®
            initDiaryList() {
                this.loading = true;
                const param = {
                    "entity": {
                        "diaryContent": this.searchKeyword,
                    },
                    "pageInfo": {
                        "currPage": this.currPage,
                        "pageSize": 10
                    }
                }
                // è¯·æ±‚
                axios({
                    method: "post",
                    url: "/fantasy-oss/api/v1/oss/diary/query.diary.group.by.date",
                    data: param
                }).then(res => {
                    // è¿½åŠ åˆ°é›†åˆä¸­
                    this.diaryGroup = Object.assign(this.diaryGroup, res.data);
                    // è·å–åˆ°æ€»é¡µæ•°
                    this.totalPage = commonUtil.getTotalPage(res);
                    this.loading = false;
                }).catch(res => {
                    this.loading = false;
                    if (res.data && res.data.msg) {
                        alert(res.data.msg)
                    } else {
                        alert("æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åå†è¯•")
                    }
                })
            },
            // æ›´æ–°é£è™¹
            updateDiary(diary) {
                // å¦‚æœä¸æ˜¯è‡ªå·±çš„åŠ¨æ€,åˆ™æ— æ³•ä¿®æ”¹
                if (diary.createBy !== this.user.id) {
                    return;
                }
                localStorage.setItem("oss.diary.id", diary.id);
                window.location = "/fantasy-oss/xiu-gai-fei-hong.html";
            },
            // é‡å®šå‘åˆ°æˆ‘çš„ç²‰ä¸
            redirectFollower() {
                window.location = "/fantasy-oss/wo-de-fen-si.html";
            },
            // é‡å®šå‘åˆ°æˆ‘çš„è®¢é˜…
            redirectSubscribe() {
                window.location = "/fantasy-oss/wo-de-ding-yue.html";
            },
            // æ›´æ”¹æœç´¢æ¡†
            changeSearchBar(bool) {
                // è®¾ç½®æœç´¢æ¡†çŠ¶æ€
                this.searchBar = bool;
                // æ¸…ç©ºåˆ—è¡¨
                this.diaryGroup = {};
                // é‡ç½®ä¸ºç¬¬ä¸€é¡µ
                this.currPage = 1;
                // å…³é—­çª—å£
                if (bool) {
                    // è·å–ç„¦ç‚¹
                    this.$nextTick(() => {
                        this.$refs.searchInput.focus();
                    });
                } else {
                    // å…³é”®å­—
                    this.searchKeyword = null;
                    // é‡æ–°æŸ¥è¯¢
                    this.initDiaryList();
                }
            },
            // æŸ¥è¯¢ç¡®è®¤
            searchConfirm() {
                // æ¸…ç©ºåˆ—è¡¨
                this.diaryGroup = {};
                // æŸ¥è¯¢
                this.initDiaryList();
            },
            // åˆ‡æ¢è‡³æ—§ç‰ˆæœ¬
            redirectOlderVersion() {
                window.location = "/fantasy-oss/fei-hong-lie-biao-jiu-ban-ben.html";
            },
            // åˆ‡æ¢è‡³å°ºå¢¨è™¹è®°
            redirectStat() {
                window.location = "/fantasy-oss/chi-mo-hong-ji.html";
            }
        },
        created() {
            // åˆå§‹åŒ–æ•°æ®
            this.initDiaryList();
            // ç”¨æˆ·ä¿¡æ¯
            this.user = commonUtil.getUserInfo();
        }
    });
</script>

</html>